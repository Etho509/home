<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GirthyCatboy’s Color Mixer for Joy of Painting</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121923; --muted:#8aa0b2; --text:#e7eef6; --acc:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e141c 40%,#0b0f14);color:var(--text);font:16px/1.45 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid #1f2a36;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{display:flex;gap:14px;align-items:center;margin-bottom:18px}
    h1{font-size:20px;margin:0;font-weight:700}
    p.sub{margin:0;color:var(--muted)}
    .pane{padding:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    label{font-weight:600;font-size:14px}
    input[type="text"],input[type="number"],button,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #223041;background:#0e1420;color:var(--text)}
    input[type="checkbox"]{transform:scale(1.1);vertical-align:middle}
    button{cursor:pointer;background:linear-gradient(180deg,#3e8cff,#2b6fe0);border:1px solid #2d6fdd;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    .swatch{width:48px;height:48px;border-radius:10px;border:1px solid #203048}
    .stack{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .result{display:grid;grid-template-columns:1fr;gap:14px}
    .step{padding:12px 14px;border:1px dashed #2a3b52;border-radius:12px;background:#0c131e}
    code{background:#0f1625;border:1px solid #1f2a36;border-radius:8px;padding:2px 6px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #2a3b52;background:#0c131e;margin:2px 6px 2px 0}
    footer{opacity:.85;font-size:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="pane">
        <header>
          <div class="swatch" id="targetSwatch" title="Target"></div>
          <div>
            <h1>GirthyCatboy’s Color Mixer for Joy of Painting</h1>
            <p class="sub">Enter a hex color. The app finds dye steps that approximate it using Minecraft’s dye averaging on a <b>white canvas base</b>. Includes optional IRL mode and snap‑to‑dye.</p>
          </div>
        </header>

        <div class="row">
          <div>
            <label for="hex">Target Hex</label>
            <input id="hex" type="text" placeholder="#2563EB" value="#2563EB" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="run">Compute Recipe</button>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Search Depth</label>
            <div class="grid-3">
              <div>
                <span class="muted">One‑step: max dyes</span>
                <input id="d1" type="number" min="1" max="6" value="4" />
              </div>
              <div>
                <span class="muted">Two‑step: max dyes/step</span>
                <input id="d2" type="number" min="1" max="5" value="3" />
              </div>
              <div>
                <span class="muted">Use two‑step search</span>
                <div><input id="enableTwo" type="checkbox" checked> <label for="enableTwo" class="muted">Enabled</label></div>
              </div>
            </div>
          </div>
          <div>
            <label>Optional ΔE cutoff</label>
            <div class="stack">
              <input id="deltaCutoff" type="number" step="0.1" min="0" placeholder="e.g. 2.0 (optional)"/>
              <span class="muted">Lower = stricter match</span>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>IRL Paint Mode</label>
            <div class="stack">
              <input id="irlMode" type="checkbox"> <span class="muted">Linear‑light preview & target compensation</span>
            </div>
            <div class="stack" style="margin-top:8px">
              <span class="muted">Compensate brightness</span>
              <input id="comp" type="number" min="0.7" max="1.3" step="0.02" value="1.08" style="max-width:140px"/>
              <span class="muted">(try 1.06–1.12)</span>
            </div>
            <div class="stack" style="margin-top:12px">
              <input id="snapEnable" type="checkbox" checked>
              <span class="muted">Snap to nearest default dye if ΔE ≤</span>
              <input id="snapThreshold" type="number" min="0" step="0.1" value="2" style="max-width:100px"/>
            </div>
          </div>
          <div>
            <label>Speed / Search Mode</label>
            <div class="stack" style="flex-wrap:wrap">
              <select id="mode" style="max-width:220px">
                <option value="beam" selected>Beam search (fast)</option>
                <option value="brute">Brute force</option>
              </select>
              <span class="muted">Beam width</span>
              <input id="beam" type="number" min="50" max="2000" step="50" value="200" style="max-width:110px"/>
              <span class="muted">Early stop ΔE ≤</span>
              <input id="early" type="number" min="0" step="0.1" value="1.0" style="max-width:100px"/>
              <label class="stack"><input id="worker" type="checkbox" checked> <span class="muted">Run in background (Web Worker)</span></label>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <div>Recipe Summary</div>
            <div id="summary" class="muted">—</div>
          </div>
          <div class="stack">
            <div class="swatch" id="matchSwatch" title="In‑game match"></div>
            <div>
              <div>In‑game match <code id="matchHex">#—</code> · ΔE <code id="matchDe">—</code></div>
              <div class="muted">(Lower ΔE ≈ closer visual match)</div>
            </div>
          </div>
        </div>

        <div class="pane result" id="result" style="margin-top:10px"></div>
        <footer class="pane">
          In‑game simulation uses Minecraft’s leather‑dye algorithm with brightness normalization (canvas base = white). IRL mode previews linear‑light mixing and lets you compensate the target so the in‑game result appears closer to real paint.
        </footer>
      </div>
    </div>
  </div>

<script src="mixing.js"></script>
<script>
// Utility functions
function rgbObjToHex(obj){
  return '#' + [obj.r, obj.g, obj.b].map(v => v.toString(16).padStart(2, '0')).join('').toUpperCase();
}
function normHex(h){
  h = h.trim();
  if (h[0] !== '#') h = '#' + h;
  if (!/^#[0-9A-Fa-f]{6}$/.test(h)) throw new Error('Use #RRGGBB');
  return h.toUpperCase();
}

function runSearch(){
  const hexInput = document.getElementById('hex').value || '#000000';
  let target;
  try {
    target = normHex(hexInput);
  } catch (e) {
    alert(e.message);
    return;
  }
  // Update target swatch
  document.getElementById('targetSwatch').style.background = target;
  const d1 = parseInt(document.getElementById('d1').value || '4', 10);
  const d2 = parseInt(document.getElementById('d2').value || '3', 10);
  const enableTwo = document.getElementById('enableTwo').checked;
  const cutoffStr = document.getElementById('deltaCutoff').value;
  const cutoff = cutoffStr ? parseFloat(cutoffStr) : null;
  const irl = document.getElementById('irlMode').checked;
  const comp = parseFloat(document.getElementById('comp').value || '1.0');
  const snap = document.getElementById('snapEnable').checked;
  const snapTh = parseFloat(document.getElementById('snapThreshold').value || '2');
  const mode = document.getElementById('mode').value;
  const beamWidth = parseInt(document.getElementById('beam').value || '200', 10);
  const early = parseFloat(document.getElementById('early').value || '1.0');
  // Note: worker mode ignored; search runs on main thread
  const depth = enableTwo ? d1 + d2 : d1;
  const params = {
    depth,
    twoStep: enableTwo,
    beamWidth,
    earlyStop: early,
    deltaECutoff: cutoff != null ? cutoff : Infinity,
    snap,
    snapThreshold: snapTh,
    irl,
    compensation: comp,
    stepSplit: enableTwo ? d1 : undefined
  };
  let res = Mixer.search(target, params);
  // After computing the best mix, compare against the closest single dye
  // If the improvement versus the nearest dye is small, prefer the single dye
  // to avoid suggesting unnecessarily complex mixes for colours close to the defaults.
  try {
    const tgtRgb = Mixer.hexToRgb(target);
    const tgtLab = Mixer.rgbToLab([tgtRgb.r, tgtRgb.g, tgtRgb.b]);
    // Find the nearest dye with an unbounded threshold (Infinity to consider all dyes)
    const nearest = Mixer.snapToDye(tgtLab, Infinity);
    if (nearest && res.sequence && res.sequence.length > 0) {
      const improvement = nearest.deltaE - res.deltaE;
      // If improvement is small (<= 10), stick with the nearest dye
      // rather than the mixed recipe.  This prevents unnecessary mixes
      // for colours near a default dye.
      if (improvement <= 10) {
        res = {
          colour: nearest.rgb,
          deltaE: nearest.deltaE,
          counts: { [nearest.name]: 1 },
          sequence: [],
          swatches: [],
          irl: params.irl ? Mixer.mixIrl({ [nearest.name]: 1 }, params.compensation || 1) : null
        };
      }
    }
  } catch (e) {
    // fall back to original result on errors
  }
  renderResult(res, cutoff, params);
}

function renderResult(res, cutoff, params){
  if (!res) {
    document.getElementById('summary').textContent = 'No result.';
    return;
  }
  if (cutoff != null && res.deltaE > cutoff) {
    document.getElementById('matchSwatch').style.background = 'transparent';
    document.getElementById('matchHex').textContent = '#—';
    document.getElementById('matchDe').textContent = res.deltaE.toFixed(2) + ' (> cutoff)';
    document.getElementById('summary').textContent = `No recipe within ΔE ≤ ${cutoff}. Try increasing search depth or relaxing cutoff.`;
    document.getElementById('result').innerHTML = '';
    return;
  }
  const hex = rgbObjToHex(res.colour);
  document.getElementById('matchSwatch').style.background = hex;
  document.getElementById('matchHex').textContent = hex;
  document.getElementById('matchDe').textContent = (res.deltaE || 0).toFixed(2);
  // Summary
  if (res.sequence.length === 0) {
    const dyeName = Object.keys(res.counts)[0];
    document.getElementById('summary').textContent = `Snapped to default dye: ${dyeName}`;
  } else {
    let summary = '';
    if (res.twoStep && params.stepSplit) {
      const split = params.stepSplit;
      const step1 = res.sequence.slice(0, split);
      const step2 = res.sequence.slice(split);
      summary = `Step 1: ${step1.join(', ')} → Step 2: ${step2.join(', ')}`;
    } else {
      summary = 'Step 1: ' + res.sequence.join(', ');
    }
    document.getElementById('summary').textContent = summary;
  }
  // Steps
  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = '';
  if (res.sequence.length === 0) {
    const dyeName = Object.keys(res.counts)[0];
    const el = document.createElement('div');
    el.className = 'step';
    el.innerHTML = `<div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="swatch" style="width:36px;height:36px;background:${hex}" title="Default dye"></div>
          <div><b>Default dye</b>: ${dyeName} · <code>${hex}</code></div>
        </div>
        <div class="muted">no mixing needed</div>
      </div>`;
    resultDiv.appendChild(el);
    return;
  }
  // Build step-by-step using counts
  const accumCounts = {};
  res.sequence.forEach((dye, idx) => {
    accumCounts[dye] = (accumCounts[dye] || 0) + 1;
    const gameRgb = Mixer.mixCounts(accumCounts);
    const gameHex = rgbObjToHex(gameRgb);
    let irlHex = null;
    if (res.irl) {
      const irlRgb = Mixer.mixIrl(accumCounts, params.compensation || 1);
      irlHex = rgbObjToHex(irlRgb);
    }
    const fromHex = idx === 0 ? '#FFFFFF' : (() => {
      const prevCounts = {};
      res.sequence.slice(0, idx).forEach(name => {
        prevCounts[name] = (prevCounts[name] || 0) + 1;
      });
      const prevRgb = Mixer.mixCounts(prevCounts);
      return rgbObjToHex(prevRgb);
    })();
    const el = document.createElement('div');
    el.className = 'step';
    el.innerHTML = `<div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="swatch" style="width:36px;height:36px;background:${gameHex}" title="In‑game"></div>
          ${res.irl ? `<div class="swatch" style="width:36px;height:36px;background:${irlHex}" title="IRL (linear)"></div>` : ''}
          <div>
            <div><b>Step ${idx+1}</b> · In‑game <code>${gameHex}</code>${res.irl ? ` · IRL <code>${irlHex}</code>` : ''}</div>
            <div class="muted">Add: <span class='pill'>${dye.replace('_',' ')}</span></div>
          </div>
        </div>
        <div class="muted">from ${fromHex}</div>
      </div>`;
    resultDiv.appendChild(el);
  });
}

// Wire up button
const runBtn = document.getElementById('run');
runBtn.addEventListener('click', () => {
  runBtn.disabled = true;
  runBtn.textContent = 'Searching…';
  setTimeout(() => {
    try {
      runSearch();
    } finally {
      runBtn.disabled = false;
      runBtn.textContent = 'Compute Recipe';
    }
  }, 10);
});
window.addEventListener('DOMContentLoaded', () => {
  try { runSearch(); } catch (e) { console.error(e); }
});
</script>
</body>
</html>